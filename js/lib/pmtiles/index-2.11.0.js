"use strict";var pmtiles=(()=>{var e,t,r,n=Object.defineProperty,i=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,a=Object.prototype.hasOwnProperty,o=(e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of s(t))a.call(e,l)||l===r||n(e,l,{get:()=>t[l],enumerable:!(o=i(t,l))||o.enumerable});return e},l=e=>o(n({},"__esModule",{value:!0}),e),c=(e,t,r)=>new Promise((n,i)=>{var s=e=>{try{o(r.next(e))}catch(t){i(t)}},a=e=>{try{o(r.throw(e))}catch(t){i(t)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,a);o((r=r.apply(e,t)).next())}),h={};((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(h,{Compression:()=>ew,EtagMismatch:()=>ez,FetchSource:()=>ex,FileAPISource:()=>eb,PMTiles:()=>eE,Protocol:()=>ef,ResolvedValueCache:()=>eM,SharedPromiseCache:()=>eB,TileType:()=>e5,bytesToHeader:()=>e7,findTile:()=>e4,getUint64:()=>eU,leafletRasterLayer:()=>eu,readVarint:()=>e$,tileIdToZxy:()=>e6,zxyToTileId:()=>em});var _=Uint8Array,u=Uint16Array,f=Int32Array,d=new _([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),g=new _([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),$=new _([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),y=function(e,t){for(var r=new u(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var i=new f(r[30]),n=1;n<30;++n)for(var s=r[n];s<r[n+1];++s)i[s]=s-r[n]<<5|n;return{b:r,r:i}},p=y(d,2),m=p.b,w=p.r;m[28]=258,w[258]=28;var v=y(g,0),b=v.b,x=v.r,U=new u(32768);for(t=0;t<32768;++t)e=(61680&(e=(52428&(e=(43690&t)>>1|(21845&t)<<1))>>2|(13107&e)<<2))>>4|(3855&e)<<4,U[t]=((65280&e)>>8|(255&e)<<8)>>1;var T=function(e,t,r){for(var n,i=e.length,s=0,a=new u(t);s<i;++s)e[s]&&++a[e[s]-1];var o=new u(t);for(s=1;s<t;++s)o[s]=o[s-1]+a[s-1]<<1;if(r){n=new u(1<<t);var l=15-t;for(s=0;s<i;++s)if(e[s])for(var c=s<<4|e[s],h=t-e[s],_=o[e[s]-1]++<<h,f=_|(1<<h)-1;_<=f;++_)n[U[_]>>l]=c}else for(s=0,n=new u(i);s<i;++s)e[s]&&(n[s]=U[o[e[s]-1]++]>>15-e[s]);return n},z=new _(288);for(t=0;t<144;++t)z[t]=8;for(t=144;t<256;++t)z[t]=9;for(t=256;t<280;++t)z[t]=7;for(t=280;t<288;++t)z[t]=8;var D=new _(32);for(t=0;t<32;++t)D[t]=5;var C=T(z,9,1),M=T(D,5,1),B=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},E=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&r},O=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(7&t)},Z=function(e){return(e+7)/8|0},H=function(e,t,r){(null==t||t<0)&&(t=0),(null==r||r>e.length)&&(r=e.length);var n=new _(r-t);return n.set(e.subarray(t,r)),n},P=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],A=function(e,t,r){var n=Error(t||P[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,A),!r)throw n;return n},k=function(e,t,r,n){var i=e.length,s=n?n.length:0;if(!i||t.f&&!t.l)return r||new _(0);var a=!r||2!=t.i,o=t.i;r||(r=new _(3*i));var l=function(e){var t=r.length;if(e>t){var n=new _(Math.max(2*t,e));n.set(r),r=n}},c=t.f||0,h=t.p||0,u=t.b||0,f=t.l,y=t.d,p=t.m,w=t.n,v=8*i;do{if(!f){c=E(e,h,1);var x=E(e,h+1,3);if(h+=3,x){if(1==x)f=C,y=M,p=9,w=5;else if(2==x){var U=E(e,h,31)+257,z=E(e,h+10,15)+4,D=U+E(e,h+5,31)+1;h+=14;for(var P=new _(D),k=new _(19),I=0;I<z;++I)k[$[I]]=E(e,h+3*I,7);h+=3*z;for(var K=B(k),j=(1<<K)-1,S=T(k,K,1),I=0;I<D;){var R=S[E(e,h,j)];h+=15&R;var V=R>>4;if(V<16)P[I++]=V;else{var F=0,W=0;for(16==V?(W=3+E(e,h,3),h+=2,F=P[I-1]):17==V?(W=3+E(e,h,7),h+=3):18==V&&(W=11+E(e,h,127),h+=7);W--;)P[I++]=F}}var G=P.subarray(0,U),N=P.subarray(U);p=B(G),w=B(N),f=T(G,p,1),y=T(N,w,1)}else A(1)}else{var V=Z(h)+4,J=e[V-4]|e[V-3]<<8,q=V+J;if(q>i){o&&A(0);break}a&&l(u+J),r.set(e.subarray(V,q),u),t.b=u+=J,t.p=h=8*q,t.f=c;continue}if(h>v){o&&A(0);break}}a&&l(u+131072);for(var Q=(1<<p)-1,X=(1<<w)-1,Y=h;;Y=h){var F=f[O(e,h)&Q],ee=F>>4;if((h+=15&F)>v){o&&A(0);break}if(F||A(2),ee<256)r[u++]=ee;else if(256==ee){Y=h,f=null;break}else{var et=ee-254;if(ee>264){var I=ee-257,er=d[I];et=E(e,h,(1<<er)-1)+m[I],h+=er}var en=y[O(e,h)&X],ei=en>>4;en||A(3),h+=15&en;var N=b[ei];if(ei>3){var er=g[ei];N+=O(e,h)&(1<<er)-1,h+=er}if(h>v){o&&A(0);break}a&&l(u+131072);var es=u+et;if(u<N){var ea=s-N,eo=Math.min(N,es);for(ea+u<0&&A(3);u<eo;++u)r[u]=n[ea+u]}for(;u<es;u+=4)r[u]=r[u-N],r[u+1]=r[u+1-N],r[u+2]=r[u+2-N],r[u+3]=r[u+3-N];u=es}}t.l=f,t.p=Y,t.b=u,t.f=c,f&&(c=1,t.m=p,t.d=y,t.n=w)}while(!c);return u==r.length?r:H(r,0,u)},I=new _(0),K=function(e){(31!=e[0]||139!=e[1]||8!=e[2])&&A(6,"invalid gzip data");var t=e[3],r=10;4&t&&(r+=(e[10]|e[11]<<8)+2);for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!e[r++]);return r+(2&t)},j=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},S=function(e,t){return((15&e[0])!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&A(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&A(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2};function R(e,t){return k(e,{i:2},t&&t.out,t&&t.dictionary)}function V(e,t){var r=K(e);return r+8>e.length&&A(6,"invalid gzip data"),k(e.subarray(r,-8),{i:2},t&&t.out||new _(j(e)),t&&t.dictionary)}function F(e,t){return k(e.subarray(S(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}function W(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?V(e,t):(15&e[0])!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?R(e,t):F(e,t)}var G="undefined"!=typeof TextDecoder&&new TextDecoder,N=0;try{G.decode(I,{stream:!0}),N=1}catch(J){}var q=(e,t)=>e*Math.pow(2,t),Q=(e,t)=>Math.floor(e/Math.pow(2,t)),X=(e,t)=>q(e.getUint16(t+1,!0),8)+e.getUint8(t),Y=(e,t)=>q(e.getUint32(t+2,!0),16)+e.getUint16(t,!0),ee=(e,t,r,n,i)=>{if(e!=n.getUint8(i))return e-n.getUint8(i);let s=X(n,i+1);if(t!=s)return t-s;let a=X(n,i+4);return r!=a?r-a:0},et=(e,t,r,n)=>{let i=en(e,128|t,r,n);return i?{z:t,x:r,y:n,offset:i[0],length:i[1],is_dir:!0}:null},er=(e,t,r,n)=>{let i=en(e,t,r,n);return i?{z:t,x:r,y:n,offset:i[0],length:i[1],is_dir:!1}:null},en=(e,t,r,n)=>{let i=0,s=e.byteLength/17-1;for(;i<=s;){let a=s+i>>1,o=ee(t,r,n,e,17*a);if(o>0)i=a+1;else{if(!(o<0))return[Y(e,17*a+7),e.getUint32(17*a+13,!0)];s=a-1}}return null},ei=(e,t)=>e.is_dir&&!t.is_dir?1:!e.is_dir&&t.is_dir?-1:e.z!==t.z?e.z-t.z:e.x!==t.x?e.x-t.x:e.y-t.y,es=(e,t)=>{let r=e.getUint8(17*t),n=127&r;return{z:n,x:X(e,17*t+1),y:X(e,17*t+4),offset:Y(e,17*t+7),length:e.getUint32(17*t+13,!0),is_dir:r>>7==1}},ea=e=>{let t=[],r=new DataView(e);for(let n=0;n<r.byteLength/17;n++)t.push(es(r,n));return eo(t)},eo=e=>{e.sort(ei);let t=new ArrayBuffer(17*e.length),r=new Uint8Array(t);for(let n=0;n<e.length;n++){let i=e[n],s=i.z;i.is_dir&&(s|=128),r[17*n]=s,r[17*n+1]=255&i.x,r[17*n+2]=i.x>>8&255,r[17*n+3]=i.x>>16&255,r[17*n+4]=255&i.y,r[17*n+5]=i.y>>8&255,r[17*n+6]=i.y>>16&255,r[17*n+7]=255&i.offset,r[17*n+8]=255&Q(i.offset,8),r[17*n+9]=255&Q(i.offset,16),r[17*n+10]=255&Q(i.offset,24),r[17*n+11]=255&Q(i.offset,32),r[17*n+12]=255&Q(i.offset,48),r[17*n+13]=255&i.length,r[17*n+14]=i.length>>8&255,r[17*n+15]=i.length>>16&255,r[17*n+16]=i.length>>24&255}return t},el=(e,t)=>{if(e.byteLength<17)return null;let r=e.byteLength/17,n=es(e,r-1);if(n.is_dir){let i=n.z,s=t.z-i,a=Math.trunc(t.x/(1<<s)),o=Math.trunc(t.y/(1<<s));return{z:i,x:a,y:o}}return null};function ec(e){return c(this,null,function*(){let t=yield e.getBytes(0,512e3),r=new DataView(t.data),n=r.getUint32(4,!0),i=r.getUint16(8,!0),s=new TextDecoder("utf-8"),a=JSON.parse(s.decode(new DataView(t.data,10,n))),o=0;"gzip"===a.compression&&(o=2);let l=0;"minzoom"in a&&(l=+a.minzoom);let c=0;"maxzoom"in a&&(c=+a.maxzoom);let h=0,_=0,u=0,f=-180,d=-85,g=180,$=85;if(a.bounds){let y=a.bounds.split(",");f=+y[0],d=+y[1],g=+y[2],$=+y[3]}if(a.center){let p=a.center.split(",");h=+p[0],_=+p[1],u=+p[2]}let m={specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+n,rootDirectoryLength:17*i,jsonMetadataOffset:10,jsonMetadataLength:n,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:o,tileType:1,minZoom:l,maxZoom:c,minLon:f,minLat:d,maxLon:g,maxLat:$,centerZoom:u,centerLon:h,centerLat:_,etag:t.etag};return m})}function eh(e,t,r,n,i,s,a){return c(this,null,function*(){let o=yield r.getArrayBuffer(t,e.rootDirectoryOffset,e.rootDirectoryLength,e);1===e.specVersion&&(o=ea(o));let l=er(new DataView(o),n,i,s);if(l){let c=yield t.getBytes(l.offset,l.length,a),h=c.data,_=new DataView(h);return 31==_.getUint8(0)&&139==_.getUint8(1)&&(h=W(new Uint8Array(h))),{data:h}}let u=el(new DataView(o),{z:n,x:i,y:s});if(u){let f=et(new DataView(o),u.z,u.x,u.y);if(f){let d=yield r.getArrayBuffer(t,f.offset,f.length,e);1===e.specVersion&&(d=ea(d));let g=er(new DataView(d),n,i,s);if(g){let $=yield t.getBytes(g.offset,g.length,a),y=$.data,p=new DataView(y);return 31==p.getUint8(0)&&139==p.getUint8(1)&&(y=W(new Uint8Array(y))),{data:y}}}}})}var e_={getHeader:ec,getZxy:eh},eu=(e,t)=>{let r=!1,n="",i=L.GridLayer.extend({createTile:function(t,i){let s=document.createElement("img"),a=new AbortController,o=a.signal;return s.cancel=()=>{a.abort()},r||(e.getHeader().then(e=>{1==e.tileType?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):2==e.tileType?n="image/png":3==e.tileType?n="image/jpeg":4==e.tileType?n="image/webp":5==e.tileType&&(n="image/avif")}),r=!0),e.getZxy(t.z,t.x,t.y,o).then(e=>{if(e){let t=new Blob([e.data],{type:n}),r=window.URL.createObjectURL(t);s.src=r,s.cancel=null,i(null,s)}}).catch(e=>{if("AbortError"!==e.name)throw e}),s},_removeTile:function(e){let t=this._tiles[e];t&&(t.el.cancel&&t.el.cancel(),t.el.width=0,t.el.height=0,t.el.deleted=!0,L.DomUtil.remove(t.el),delete this._tiles[e],this.fire("tileunload",{tile:t.el,coords:this._keyToTileCoords(e)}))}});return new i(t)},ef=class{constructor(){this.tile=(e,t)=>{if("json"==e.type){let r=e.url.substr(10),n=this.tiles.get(r);return n||(n=new eE(r),this.tiles.set(r,n)),n.getHeader().then(r=>{let n={tiles:[e.url+"/{z}/{x}/{y}"],minzoom:r.minZoom,maxzoom:r.maxZoom,bounds:[r.minLon,r.minLat,r.maxLon,r.maxLat]};t(null,n,null,null)}).catch(e=>{t(e,null,null,null)}),{cancel(){}}}{let i=RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=e.url.match(i);if(!s)throw Error("Invalid PMTiles protocol URL");let a=s[1],o=this.tiles.get(a);o||(o=new eE(a),this.tiles.set(a,o));let l=s[2],c=s[3],h=s[4],_=new AbortController,u=_.signal,f=()=>{_.abort()};return o.getHeader().then(e=>{o.getZxy(+l,+c,+h,u).then(r=>{r?t(null,new Uint8Array(r.data),r.cacheControl,r.expires):1==e.tileType?t(null,new Uint8Array,null,null):t(null,null,null,null)}).catch(e=>{"AbortError"!==e.name&&t(e,null,null,null)})}),{cancel:f}}},this.tiles=new Map}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};function ed(e,t){return(t>>>0)*4294967296+(e>>>0)}function eg(e,t){let r=t.buf,n,i;if(n=(112&(i=r[t.pos++]))>>4,i<128||(n|=(127&(i=r[t.pos++]))<<3,i<128)||(n|=(127&(i=r[t.pos++]))<<10,i<128)||(n|=(127&(i=r[t.pos++]))<<17,i<128)||(n|=(127&(i=r[t.pos++]))<<24,i<128)||(n|=(1&(i=r[t.pos++]))<<31,i<128))return ed(e,n);throw Error("Expected varint not more than 10 bytes")}function e$(e){let t=e.buf,r,n;return(r=127&(n=t[e.pos++]),n<128)?r:(r|=(127&(n=t[e.pos++]))<<7,n<128)?r:(r|=(127&(n=t[e.pos++]))<<14,n<128)?r:(r|=(127&(n=t[e.pos++]))<<21,n<128)?r:eg(r|=(15&(n=t[e.pos]))<<28,e)}function e0(e,t,r,n){if(0==n){1==r&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);let i=t[0];t[0]=t[1],t[1]=i}}function ey(e,t){let r=Math.pow(2,e),n=t,i=t,s=t,a=[0,0],o=1;for(;o<r;)n=1&s/2,i=1&(s^n),e0(o,a,n,i),a[0]+=o*n,a[1]+=o*i,s/=4,o*=2;return[e,a[0],a[1]]}var ep=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function em(e,t,r){if(e>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(t>Math.pow(2,e)-1||r>Math.pow(2,e)-1)throw Error("tile x/y outside zoom level bounds");let n=ep[e],i=0,s=0,a=0,o=[t,r],l=Math.pow(2,e)/2;for(;l>0;)i=(o[0]&l)>0?1:0,s=(o[1]&l)>0?1:0,a+=l*l*(3*i^s),e0(l,o,i,s),l/=2;return n+a}function e6(e){let t=0;for(let r=0;r<27;r++){let n=(1<<r)*(1<<r);if(t+n>e)return ey(r,e-t);t+=n}throw Error("Tile zoom level exceeds max safe number limit (26)")}var e3,ew=((e3=ew||{})[e3.Unknown=0]="Unknown",e3[e3.None=1]="None",e3[e3.Gzip=2]="Gzip",e3[e3.Brotli=3]="Brotli",e3[e3.Zstd=4]="Zstd",e3);function ev(e,t){return c(this,null,function*(){if(1===t||0===t)return e;if(2===t){if(void 0===globalThis.DecompressionStream)return W(new Uint8Array(e));{let r=new Response(e).body.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}}throw Error("Compression method not supported")})}var e1,e5=((e1=e5||{})[e1.Unknown=0]="Unknown",e1[e1.Mvt=1]="Mvt",e1[e1.Png=2]="Png",e1[e1.Jpeg=3]="Jpeg",e1[e1.Webp=4]="Webp",e1[e1.Avif=5]="Avif",e1),e2=127;function e4(e,t){let r=0,n=e.length-1;for(;r<=n;){let i=n+r>>1,s=t-e[i].tileId;if(s>0)r=i+1;else{if(!(s<0))return e[i];n=i-1}}return n>=0&&(0===e[n].runLength||t-e[n].tileId<e[n].runLength)?e[n]:null}var eb=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return c(this,null,function*(){let r=this.file.slice(e,e+t),n=yield r.arrayBuffer();return{data:n}})}},ex=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r){return c(this,null,function*(){let n;r||(r=(n=new AbortController).signal);let i=new Headers(this.customHeaders);i.set("Range","bytes="+e+"-"+(e+t-1));let s=yield fetch(this.url,{signal:r,headers:i});if(416===s.status&&0===e){let a=s.headers.get("Content-Range");if(!a||!a.startsWith("bytes */"))throw Error("Missing content-length on 416 response");let o=+a.substr(8);s=yield fetch(this.url,{signal:r,headers:{Range:"bytes=0-"+(o-1)}})}if(s.status>=300)throw Error("Bad response code: "+s.status);let l=s.headers.get("Content-Length");if(200===s.status&&(!l||+l>t))throw n&&n.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");let c=yield s.arrayBuffer();return{data:c,etag:s.headers.get("ETag")||void 0,cacheControl:s.headers.get("Cache-Control")||void 0,expires:s.headers.get("Expires")||void 0}})}};function eU(e,t){let r=e.getUint32(t+4,!0),n=e.getUint32(t+0,!0);return 4294967296*r+n}function e7(e,t){let r=new DataView(e),n=r.getUint8(7);if(n>3)throw Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:eU(r,8),rootDirectoryLength:eU(r,16),jsonMetadataOffset:eU(r,24),jsonMetadataLength:eU(r,32),leafDirectoryOffset:eU(r,40),leafDirectoryLength:eU(r,48),tileDataOffset:eU(r,56),tileDataLength:eU(r,64),numAddressedTiles:eU(r,72),numTileEntries:eU(r,80),numTileContents:eU(r,88),clustered:1===r.getUint8(96),internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:t}}function eT(e){let t={buf:new Uint8Array(e),pos:0},r=e$(t),n=[],i=0;for(let s=0;s<r;s++){let a=e$(t);n.push({tileId:i+a,offset:0,length:0,runLength:1}),i+=a}for(let o=0;o<r;o++)n[o].runLength=e$(t);for(let l=0;l<r;l++)n[l].length=e$(t);for(let c=0;c<r;c++){let h=e$(t);0===h&&c>0?n[c].offset=n[c-1].offset+n[c-1].length:n[c].offset=h-1}return n}function eL(e){let t=new DataView(e);return 2===t.getUint16(2,!0)?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):1===t.getUint16(2,!0)?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var ez=class extends Error{};function eD(e,t,r,n){return c(this,null,function*(){let i=yield e.getBytes(0,16384),s=new DataView(i.data);if(19792!==s.getUint16(0,!0))throw Error("Wrong magic number for PMTiles archive");if(3>eL(i.data))return[(yield e_.getHeader(e))];let a=i.data.slice(0,e2),o=i.etag;n&&i.etag!=n&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+e.getKey()),o=void 0);let l=e7(a,o);if(r){let c=i.data.slice(l.rootDirectoryOffset,l.rootDirectoryOffset+l.rootDirectoryLength),h=e.getKey()+"|"+(l.etag||"")+"|"+l.rootDirectoryOffset+"|"+l.rootDirectoryLength,_=eT((yield t(c,l.internalCompression)));return[l,[h,_.length,_]]}return[l,void 0]})}function eC(e,t,r,n,i){return c(this,null,function*(){let s=yield e.getBytes(r,n);if(i.etag&&i.etag!==s.etag)throw new ez(s.etag);let a=yield t(s.data,i.internalCompression),o=eT(a);if(0===o.length)throw Error("Empty directory is invalid");return o})}var eM=class{constructor(e=100,t=!0,r=ev){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=t,this.decompress=r}getHeader(e,t){return c(this,null,function*(){let r=e.getKey();if(this.cache.has(r)){this.cache.get(r).lastUsed=this.counter++;let n=this.cache.get(r).data;return n}let i=yield eD(e,this.decompress,this.prefetch,t);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(r,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]})}getDirectory(e,t,r,n){return c(this,null,function*(){let i=e.getKey()+"|"+(n.etag||"")+"|"+t+"|"+r;if(this.cache.has(i)){this.cache.get(i).lastUsed=this.counter++;let s=this.cache.get(i).data;return s}let a=yield eC(e,this.decompress,t,r,n);return this.cache.set(i,{lastUsed:this.counter++,data:a}),this.prune(),a})}getArrayBuffer(e,t,r,n){return c(this,null,function*(){let i=e.getKey()+"|"+(n.etag||"")+"|"+t+"|"+r;if(this.cache.has(i)){this.cache.get(i).lastUsed=this.counter++;let s=yield this.cache.get(i).data;return s}let a=yield e.getBytes(t,r);if(n.etag&&n.etag!==a.etag)throw new ez(n.etag);return this.cache.set(i,{lastUsed:this.counter++,data:a.data}),this.prune(),a.data})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e,t){return c(this,null,function*(){this.cache.delete(e.getKey()),yield this.getHeader(e,t)})}},eB=class{constructor(e=100,t=!0,r=ev){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=t,this.decompress=r}getHeader(e,t){return c(this,null,function*(){let r=e.getKey();if(this.cache.has(r)){this.cache.get(r).lastUsed=this.counter++;let n=yield this.cache.get(r).data;return n}let i=new Promise((r,n)=>{eD(e,this.decompress,this.prefetch,t).then(e=>{e[1]&&this.cache.set(e[1][0],{lastUsed:this.counter++,data:Promise.resolve(e[1][2])}),r(e[0]),this.prune()}).catch(e=>{n(e)})});return this.cache.set(r,{lastUsed:this.counter++,data:i}),i})}getDirectory(e,t,r,n){return c(this,null,function*(){let i=e.getKey()+"|"+(n.etag||"")+"|"+t+"|"+r;if(this.cache.has(i)){this.cache.get(i).lastUsed=this.counter++;let s=yield this.cache.get(i).data;return s}let a=new Promise((i,s)=>{eC(e,this.decompress,t,r,n).then(e=>{i(e),this.prune()}).catch(e=>{s(e)})});return this.cache.set(i,{lastUsed:this.counter++,data:a}),a})}getArrayBuffer(e,t,r,n){return c(this,null,function*(){let i=e.getKey()+"|"+(n.etag||"")+"|"+t+"|"+r;if(this.cache.has(i)){this.cache.get(i).lastUsed=this.counter++;let s=yield this.cache.get(i).data;return s}let a=new Promise((s,a)=>{e.getBytes(t,r).then(e=>{if(n.etag&&n.etag!==e.etag)throw new ez(e.etag);s(e.data),this.cache.has(i),this.prune()}).catch(e=>{a(e)})});return this.cache.set(i,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e,t){return c(this,null,function*(){this.cache.delete(e.getKey()),yield this.getHeader(e,t)})}},eE=class{constructor(e,t,r){"string"==typeof e?this.source=new ex(e):this.source=e,r?this.decompress=r:this.decompress=ev,t?this.cache=t:this.cache=new eB}getHeader(){return c(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,n){return c(this,null,function*(){let i=em(e,t,r),s=yield this.cache.getHeader(this.source);if(s.specVersion<3)return e_.getZxy(s,this.source,this.cache,e,t,r,n);if(e<s.minZoom||e>s.maxZoom)return;let a=s.rootDirectoryOffset,o=s.rootDirectoryLength;for(let l=0;l<=3;l++){let c=yield this.cache.getDirectory(this.source,a,o,s),h=e4(c,i);if(!h)return;if(h.runLength>0){let _=yield this.source.getBytes(s.tileDataOffset+h.offset,h.length,n);if(s.etag&&s.etag!==_.etag)throw new ez(_.etag);return{data:yield this.decompress(_.data,s.tileCompression),cacheControl:_.cacheControl,expires:_.expires}}a=s.leafDirectoryOffset+h.offset,o=h.length}throw Error("Maximum directory depth exceeded")})}getZxy(e,t,r,n){return c(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,n)}catch(i){if(i instanceof ez)return this.cache.invalidate(this.source,i.message),yield this.getZxyAttempt(e,t,r,n);throw i}})}getMetadataAttempt(){return c(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength);if(e.etag&&e.etag!==t.etag)throw new ez(t.etag);let r=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(r))})}getMetadata(){return c(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof ez)return this.cache.invalidate(this.source,e.message),yield this.getMetadataAttempt();throw e}})}};return l(h)})();